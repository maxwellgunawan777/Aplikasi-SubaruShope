<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Tagihan & Sales SShope</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ultra Thin Scrollbar - Visible but sleek */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            font-size: 11px; 
            overflow: hidden; /* Kunci scroll utama halaman */
            height: 100vh; /* Paksa tinggi pas 100% layar */
        }
        .card-compact {
            @apply bg-white p-2 rounded-lg shadow-md border border-sky-100;
        }
        .input-compact {
            @apply p-1 border border-slate-300 rounded w-full focus:ring-1 focus:ring-sky-500 focus:border-sky-500 text-[10px] h-6;
        }
        .btn-compact {
            @apply py-0.5 px-2 rounded text-[10px] font-bold shadow-sm transition-all h-6 flex items-center justify-center;
        }
        .section-title {
            @apply text-xs font-bold text-slate-700 border-b border-slate-200 pb-1 mb-1 uppercase tracking-wide;
        }
        .label-compact {
            @apply text-[9px] font-semibold text-slate-500 mb-0.5 block uppercase;
        }
        .row-item {
            @apply flex items-center p-0.5 border-b border-slate-50 hover:bg-sky-50 text-[10px] transition-colors;
        }
    </style>
</head>
<body class="p-2 flex flex-col relative h-screen box-border">
    <!-- Error Log -->
    <div id="error-container" class="hidden max-w-7xl mx-auto mb-1 p-1 bg-red-100 border border-red-400 text-red-700 rounded text-[10px]">
        <span class="font-bold">Error:</span> <span id="error-message"></span>
    </div>

    <!-- EDIT MODAL OVERLAY -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-900/30 hidden z-50 flex items-center justify-center backdrop-blur-[2px]">
        <div class="bg-white rounded-lg shadow-2xl p-3 w-full max-w-xs transform transition-all scale-100 border border-slate-200">
            <h3 class="text-xs font-bold text-sky-900 mb-2 border-b pb-1">Edit Transaksi</h3>
            <form id="edit-form" class="space-y-2">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">
                <div><label class="label-compact">Deskripsi / Nama</label><input type="text" id="edit-desc" class="input-compact w-full" required></div>
                <div id="edit-field-amount-wrapper"><label class="label-compact">Jumlah (Rp)</label><input type="number" id="edit-amount" class="input-compact w-full" min="0"></div>
                <div id="edit-fields-qty-price" class="hidden grid grid-cols-2 gap-2">
                    <div><label class="label-compact">Qty</label><input type="number" id="edit-qty" class="input-compact w-full" min="1"></div>
                    <div><label class="label-compact">Harga</label><input type="number" id="edit-price" class="input-compact w-full" min="0"></div>
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" id="cancel-edit" class="btn-compact bg-slate-100 text-slate-600 hover:bg-slate-200">Batal</button>
                    <button type="submit" class="btn-compact bg-sky-600 text-white hover:bg-sky-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <header class="flex justify-between items-center px-3 py-1 bg-white rounded shadow-sm mb-1 border border-sky-200 shrink-0 h-8">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-4 bg-sky-500 rounded-full"></div>
            <h1 class="text-xs font-extrabold text-slate-700 leading-none">Aplikasi Tagihan & Sales SShope</h1>
        </div>
        <div id="auth-status" class="text-[9px] text-sky-500 font-mono bg-sky-50 px-2 py-0.5 rounded border border-sky-100">Connecting...</div>
    </header>

    <div id="loading" class="text-center p-10 text-sky-600 font-bold text-xs absolute inset-0 flex items-center justify-center bg-white/80 z-40 backdrop-blur-sm">
        Memuat Data...
    </div>

    <!-- MAIN CONTENT GRID - LOCKED HEIGHT -->
    <!-- 'flex-grow overflow-hidden' ensures it fills available vertical space but cuts off overflow -->
    <div id="main-content" class="hidden flex-grow overflow-hidden pb-1 h-full">
        <div class="grid grid-cols-12 gap-2 h-full">
            
            <!-- LEFT PANEL: NOTA (45% Width) - LOCKED LAYOUT -->
            <div class="col-span-5 flex flex-col h-full card-compact overflow-hidden">
                <div class="shrink-0">
                    <h2 class="section-title text-amber-600 border-amber-100">1. Rekap Nota Pembelian Sparepart</h2>
                    <form id="nota-form" class="mb-1 flex gap-1">
                        <input type="text" id="nota-description" placeholder="Deskripsi (TGL 1)" class="input-compact flex-[2]" required>
                        <input type="number" id="nota-amount" placeholder="Rp" class="input-compact flex-[1]" required min="0">
                        <button type="submit" class="btn-compact bg-amber-500 hover:bg-amber-600 text-white px-2 shadow-amber-200">+</button>
                    </form>
                </div>

                <!-- SCROLLABLE LIST AREA (KUNCI DI SINI: flex-grow + h-0 + overflow-y-auto) -->
                <!-- Ini memaksa div untuk scroll di dalam area yang tersisa, bukan memanjang ke bawah -->
                <div class="flex-grow h-0 overflow-y-auto pr-1 border border-slate-100 rounded bg-slate-50/50">
                    <div id="nota-list-container" class="grid grid-cols-2 gap-x-2 gap-y-0 content-start p-0.5">
                        <div id="nota-column-1" class="flex flex-col w-full min-w-0"></div>
                        <div id="nota-column-2" class="flex flex-col w-full min-w-0 hidden"></div>
                    </div>
                </div>
                
                <div class="shrink-0 mt-1 pt-1 border-t border-amber-100">
                    <div class="flex justify-between items-center text-[10px] font-bold text-slate-700 bg-amber-50 p-1 rounded border border-amber-100">
                        <span>TOTAL:</span>
                        <span id="total-nota" class="text-amber-600 text-xs">Rp 0</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL (55% Width) - STATIC -->
            <div class="col-span-7 flex flex-col h-full gap-2 overflow-hidden">
                
                <!-- TOP RIGHT: TAGIHAN LAIN & RETUR (Static Height 35%) -->
                <div class="grid grid-cols-2 gap-2 h-[35%] shrink-0">
                    <!-- Tagihan Lain -->
                    <div class="card-compact flex flex-col h-full min-h-0 overflow-hidden">
                        <h2 class="section-title text-emerald-600 border-emerald-100">2. Tagihan Lainnya</h2>
                        <form id="expense-form" class="mb-1 flex gap-1 shrink-0">
                            <input type="text" id="expense-name" placeholder="Nama" class="input-compact flex-1 min-w-0" required>
                            <input type="number" id="expense-qty" placeholder="Q" class="input-compact w-8 text-center px-0" value="1">
                            <input type="number" id="expense-price" placeholder="Harga" class="input-compact w-20">
                            <button type="submit" class="btn-compact bg-emerald-500 text-white hover:bg-emerald-600 px-2 shadow-emerald-200">+</button>
                        </form>
                        <div id="expense-list" class="flex-grow h-0 overflow-y-auto border border-slate-100 rounded mb-1 bg-slate-50/50"></div>
                        <div class="flex justify-between font-bold text-[9px] text-emerald-700 pt-0.5 border-t border-emerald-100 shrink-0 mt-auto">
                            <span>Total Lainnya:</span> <span id="total-expense">Rp 0</span>
                        </div>
                    </div>

                    <!-- Retur -->
                    <div class="card-compact flex flex-col h-full min-h-0 overflow-hidden">
                        <h2 class="section-title text-rose-600 border-rose-100">3. Retur Barang</h2>
                        <form id="return-form" class="mb-1 flex gap-1 shrink-0">
                            <input type="text" id="return-name" placeholder="Nama" class="input-compact flex-1 min-w-0" required>
                            <input type="number" id="return-qty" placeholder="Q" class="input-compact w-8 text-center px-0" value="1">
                            <input type="number" id="return-price" placeholder="Harga" class="input-compact w-20">
                            <button type="submit" class="btn-compact bg-rose-500 text-white hover:bg-rose-600 px-2 shadow-rose-200">+</button>
                        </form>
                        <div id="return-list" class="flex-grow h-0 overflow-y-auto border border-slate-100 rounded mb-1 bg-slate-50/50"></div>
                        <div class="flex justify-between font-bold text-[9px] text-rose-700 pt-0.5 border-t border-rose-100 shrink-0 mt-auto">
                            <span>Total Retur:</span> <span id="total-return">- Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE RIGHT: TOTAL BILLING -->
                <div class="bg-white px-2 py-1 rounded-lg border border-sky-200 shadow-sm shrink-0 flex justify-between items-center h-8">
                    <h2 class="text-[10px] font-bold text-sky-800 uppercase tracking-wider">4. Total Billing</h2>
                    <span id="final-billing" class="text-sm font-black text-sky-600">Rp 0</span>
                </div>

                <!-- BOTTOM RIGHT: PROFIT CALCULATION -->
                <div class="card-compact flex-grow h-0 flex flex-col border-t-2 border-t-indigo-500 min-h-0 overflow-hidden">
                    <h2 class="section-title text-indigo-600 border-indigo-100 mb-1">5. Kalkulasi Profit Bulanan</h2>
                    
                    <div class="grid grid-cols-12 gap-2 h-full min-h-0">
                        <!-- INPUTS -->
                        <div class="col-span-7 grid grid-cols-2 gap-x-2 gap-y-0.5 content-start overflow-y-auto pr-1">
                            <div><label class="label-compact">a. Saldo Bank</label><input type="number" id="saldo-bank" class="input-compact w-full bg-slate-50" value="0"></div>
                            <div><label class="label-compact">e. Ongoing Toped</label><input type="number" id="ongoing-topedtiktok" class="input-compact w-full bg-slate-50" value="0"></div>
                            
                            <div><label class="label-compact">b. Saldo Shopee</label><input type="number" id="saldo-shopee" class="input-compact w-full bg-slate-50" value="0"></div>
                            <div><label class="label-compact">f. Saldo Lazada</label><input type="number" id="saldo-lazada" class="input-compact w-full bg-slate-50" value="0"></div>
                            
                            <div><label class="label-compact">c. Ongoing Shopee</label><input type="number" id="ongoing-shopee" class="input-compact w-full bg-slate-50" value="0"></div>
                            <div><label class="label-compact">g. Ongoing Lazada</label><input type="number" id="ongoing-lazada" class="input-compact w-full bg-slate-50" value="0"></div>
                            
                            <div><label class="label-compact">d. Saldo Toped</label><input type="number" id="saldo-topedtiktok" class="input-compact w-full bg-slate-50" value="0"></div>
                            <div><label class="label-compact text-emerald-600">h. Saldo Terpakai (+)</label><input type="number" id="saldo-terpakai" class="input-compact w-full bg-emerald-50 border-emerald-200 text-emerald-700 font-bold" value="0"></div>
                            
                            <div class="col-span-2 mt-1 pb-1">
                                <button id="calculate-profit-btn" class="btn-compact w-full bg-indigo-600 text-white hover:bg-indigo-700 h-5 text-[9px] shadow-indigo-200">HITUNG PROFIT</button>
                            </div>
                        </div>

                        <!-- RESULTS SUMMARY -->
                        <div class="col-span-5 flex flex-col justify-start pl-2 border-l border-slate-100 text-[9px] gap-0.5 pt-1">
                            <div class="space-y-0.5">
                                <div class="flex justify-between border-b border-slate-100 pb-0.5">
                                    <span class="text-slate-400 font-medium">Saldo Kotor</span>
                                    <span id="total-saldo-kotor" class="font-bold text-slate-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between border-b border-emerald-100 pb-0.5">
                                    <span class="text-emerald-600 font-bold">Terpakai (+)</span>
                                    <span id="saldo-terpakai-display" class="font-bold text-emerald-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between border-b border-sky-100 pb-0.5">
                                    <span class="text-sky-600 font-bold">Billing (-)</span>
                                    <span id="billing-for-profit" class="font-bold text-sky-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between pt-0.5">
                                    <span class="text-slate-500 font-semibold">Total Pendapatan</span>
                                    <span id="total-saldo-bersih" class="font-bold text-slate-700">Rp 0</span>
                                </div>
                            </div>
                            
                            <div class="mt-1 p-1.5 bg-indigo-50 rounded text-center border border-indigo-100">
                                <div class="text-[8px] font-bold text-indigo-400 uppercase tracking-widest">PROFIT BERSIH</div>
                                <div id="final-profit" class="text-base font-black text-indigo-900 leading-tight mt-0">Rp 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        try {
            // --- CONFIG FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyBtIkNiTVfqi314s7HokDOSkjXnl1P_AoE",
                authDomain: "aplikasi-subarushope.firebaseapp.com",
                projectId: "aplikasi-subarushope",
                storageBucket: "aplikasi-subarushope.firebasestorage.app",
                messagingSenderId: "201701466790",
                appId: "1:201701466790:web:f24db5db1471e173314a67"
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId;

            // UI References
            const els = {
                authStatus: document.getElementById('auth-status'), loading: document.getElementById('loading'), main: document.getElementById('main-content'),
                notaCol1: document.getElementById('nota-column-1'), notaCol2: document.getElementById('nota-column-2'),
                expenseList: document.getElementById('expense-list'), returnList: document.getElementById('return-list'),
                totalNota: document.getElementById('total-nota'), totalExpense: document.getElementById('total-expense'), totalReturn: document.getElementById('total-return'),
                finalBilling: document.getElementById('final-billing'), billingForProfit: document.getElementById('billing-for-profit'),
                finalProfit: document.getElementById('final-profit'), editModal: document.getElementById('edit-modal'), editForm: document.getElementById('edit-form')
            };

            const inputs = {
                bank: document.getElementById('saldo-bank'), shopee: document.getElementById('saldo-shopee'), ongoingShopee: document.getElementById('ongoing-shopee'),
                toped: document.getElementById('saldo-topedtiktok'), ongoingToped: document.getElementById('ongoing-topedtiktok'),
                lazada: document.getElementById('saldo-lazada'), ongoingLazada: document.getElementById('ongoing-lazada'), terpakai: document.getElementById('saldo-terpakai')
            };

            // Initialize Auth
            async function initAuth() {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (err) {
                    await signInAnonymously(auth);
                }
            }
            initAuth();

            onAuthStateChanged(auth, (user) => {
                if(user) {
                    userId = user.uid;
                    els.authStatus.textContent = `ONLINE`;
                    els.authStatus.className = "text-[9px] text-emerald-500 font-bold bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100";
                    els.loading.classList.add('hidden');
                    els.main.classList.remove('hidden');
                    startListeners();
                }
            });

            let allTransactions = [];
            function getPath(col) { return `artifacts/${appId}/users/${userId}/${col}`; }
            function formatRp(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }

            function startListeners() {
                onSnapshot(query(collection(db, getPath('transactions'))), (snap) => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const notas = data.filter(d => d.type === 'nota').sort((a,b) => (a.date?.seconds || 0) - (b.date?.seconds || 0));
                    const others = data.filter(d => d.type !== 'nota');
                    allTransactions = [...notas, ...others];
                    render(); calc();
                });
                onSnapshot(doc(db, getPath('summary'), 'profit_summary'), (snap) => {
                    if(snap.exists()) { const d = snap.data(); Object.keys(inputs).forEach(key => { if(inputs[key]) inputs[key].value = d[key] || 0; }); }
                    calc();
                });
            }

            // Modal Logic
            window.openEditModal = function(id, type) {
                const item = allTransactions.find(t => t.id === id); if (!item) return;
                document.getElementById('edit-id').value = id; document.getElementById('edit-type').value = type;
                document.getElementById('edit-desc').value = item.description || item.name;
                const isNota = type === 'nota';
                document.getElementById('edit-field-amount-wrapper').classList.toggle('hidden', !isNota);
                document.getElementById('edit-fields-qty-price').classList.toggle('hidden', isNota);
                if(isNota) document.getElementById('edit-amount').value = item.amount;
                else { document.getElementById('edit-qty').value = item.quantity; document.getElementById('edit-price').value = item.price; }
                els.editModal.classList.remove('hidden');
            };
            document.getElementById('cancel-edit').onclick = () => els.editModal.classList.add('hidden');
            
            els.editForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value; const type = document.getElementById('edit-type').value; const desc = document.getElementById('edit-desc').value;
                let newData = type === 'nota' ? { description: desc, amount: parseFloat(document.getElementById('edit-amount').value) } 
                    : { name: desc, quantity: parseFloat(document.getElementById('edit-qty').value), price: parseFloat(document.getElementById('edit-price').value), amount: parseFloat(document.getElementById('edit-qty').value) * parseFloat(document.getElementById('edit-price').value) };
                await updateDoc(doc(db, getPath('transactions'), id), newData); els.editModal.classList.add('hidden');
            };

            function render() {
                els.notaCol1.innerHTML = ''; els.notaCol2.innerHTML = ''; els.expenseList.innerHTML = ''; els.returnList.innerHTML = '';
                const notas = allTransactions.filter(t => t.type === 'nota'); const others = allTransactions.filter(t => t.type !== 'nota');
                notas.slice(0, 30).forEach((t, i) => els.notaCol1.appendChild(createNotaEl(t, i+1)));
                if(notas.length > 30) { els.notaCol2.classList.remove('hidden'); notas.slice(30).forEach((t, i) => els.notaCol2.appendChild(createNotaEl(t, 31+i))); } else els.notaCol2.classList.add('hidden');
                others.forEach(t => (t.type === 'expense' ? els.expenseList : els.returnList).appendChild(createOtherEl(t)));
                document.querySelectorAll('.btn-del').forEach(b => b.onclick = () => deleteDoc(doc(db, getPath('transactions'), b.dataset.id)));
                document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => window.openEditModal(b.dataset.id, b.dataset.type));
            }

            function createNotaEl(t, idx) {
                const div = document.createElement('div'); div.className = 'flex items-center p-0.5 border-b border-slate-50 hover:bg-amber-50 text-[10px] group transition-colors';
                div.innerHTML = `
                    <div class="font-bold text-slate-400 w-5 text-center shrink-0 text-[9px]">${idx}.</div>
                    <div class="flex-1 min-w-0 flex items-center gap-1 mr-1">
                        <span class="truncate text-slate-700 font-medium flex-1 cursor-help" title="${t.description}">${t.description}</span>
                        <span class="text-slate-300 text-[9px] shrink-0">|</span>
                        <span class="text-amber-600 font-bold whitespace-nowrap shrink-0 text-[10px]">${formatRp(t.amount)}</span>
                    </div>
                    <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button class="p-0.5 text-slate-400 hover:text-sky-600 btn-edit transition-colors" data-id="${t.id}" data-type="nota">✎</button>
                        <button class="p-0.5 text-slate-400 hover:text-rose-600 btn-del transition-colors" data-id="${t.id}">✕</button>
                    </div>
                `;
                return div;
            }

            function createOtherEl(t) {
                const isExp = t.type === 'expense'; const div = document.createElement('div'); 
                div.className = `flex items-center p-0.5 border-b border-slate-50 hover:${isExp ? 'bg-emerald-50' : 'bg-rose-50'} text-[10px] group transition-colors`;
                div.innerHTML = `
                    <span class="truncate font-medium text-slate-700 flex-1 min-w-0" title="${t.name}">${t.name} <span class="text-slate-400 text-[9px]">(${t.quantity}x)</span></span>
                    <span class="font-bold ${isExp?'text-emerald-600':'text-rose-600'} mr-1 ml-1 shrink-0">${isExp?'':'- '}${formatRp(t.amount)}</span>
                    <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                        <button class="p-0.5 text-slate-400 hover:text-sky-600 btn-edit transition-colors" data-id="${t.id}" data-type="${t.type}">✎</button>
                        <button class="p-0.5 text-slate-400 hover:text-rose-600 btn-del transition-colors" data-id="${t.id}">✕</button>
                    </div>
                `;
                return div;
            }

            function calc() {
                let sumNota=0, sumExp=0, sumRet=0;
                allTransactions.forEach(t => { if(t.type==='nota') sumNota+=t.amount; else if(t.type==='expense') sumExp+=t.amount; else sumRet+=t.amount; });
                const bill = (sumNota + sumExp) - sumRet;
                els.totalNota.textContent = formatRp(sumNota); els.totalExpense.textContent = formatRp(sumExp); els.totalReturn.textContent = `- ${formatRp(sumRet)}`;
                els.finalBilling.textContent = formatRp(bill); els.billingForProfit.textContent = formatRp(bill);
                
                let vals = {}; Object.keys(inputs).forEach(k => vals[k] = parseFloat(inputs[k].value)||0);
                const kotor = vals.bank + vals.shopee + vals.ongoingShopee + vals.toped + vals.ongoingToped + vals.lazada + vals.ongoingLazada;
                
                // LOGIC BARU: Profit = (Saldo Kotor + Terpakai) - Tagihan
                const totalPendapatan = kotor + vals.terpakai;
                const profit = totalPendapatan - bill;

                document.getElementById('total-saldo-kotor').textContent = formatRp(kotor);
                document.getElementById('saldo-terpakai-display').textContent = formatRp(vals.terpakai);
                document.getElementById('total-saldo-bersih').textContent = formatRp(totalPendapatan); // Label di UI: Total Pendapatan
                els.finalProfit.textContent = formatRp(profit);
                els.finalProfit.className = `text-2xl font-black leading-none ${profit>=0 ? 'text-indigo-900' : 'text-rose-600'}`;

                if(window.saveTimeout) clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => setDoc(doc(db, getPath('summary'), 'profit_summary'), vals, {merge:true}), 1000);
            }

            document.getElementById('nota-form').onsubmit = (e) => { e.preventDefault(); handleAdd('nota', document.getElementById('nota-description').value, document.getElementById('nota-amount').value); e.target.reset(); };
            document.getElementById('expense-form').onsubmit = (e) => { e.preventDefault(); handleAdd('expense', document.getElementById('expense-name').value, 0, document.getElementById('expense-qty').value, document.getElementById('expense-price').value); e.target.reset(); };
            document.getElementById('return-form').onsubmit = (e) => { e.preventDefault(); handleAdd('return', document.getElementById('return-name').value, 0, document.getElementById('return-qty').value, document.getElementById('return-price').value); e.target.reset(); };
            function handleAdd(type, desc, amt=0, qty=1, prc=0) { let data = type === 'nota' ? {description:desc, amount:parseFloat(amt)} : {name:desc, quantity:parseFloat(qty), price:parseFloat(prc), amount:parseFloat(qty)*parseFloat(prc)}; data.type = type; data.date = new Date(); addDoc(collection(db, getPath('transactions')), data); }
            document.getElementById('calculate-profit-btn').onclick = calc; Object.values(inputs).forEach(inp => inp.oninput = calc);

        } catch(e) { document.getElementById('loading').style.display='none'; document.getElementById('error-container').classList.remove('hidden'); document.getElementById('error-message').textContent = e.message; }
    </script>
</body>
</html>
