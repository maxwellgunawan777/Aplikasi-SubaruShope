<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Tagihan & Sales SShope</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }, // Blue Primary
                        accent: { 50: '#fdf2f8', 500: '#ec4899', 600: '#db2777' }, // Pink/Rose for accents
                        success: { 50: '#f0fdf4', 500: '#22c55e', 600: '#16a34a' }, // Emerald
                        danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }, // Red
                        warning: { 50: '#fffbeb', 500: '#f59e0b', 600: '#d97706' }, // Amber
                    },
                    fontSize: {
                        'xxs': '10px',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; font-size: 11px; overflow: hidden; height: 100vh; }
        
        .card-glass {
            @apply bg-white border border-slate-200 shadow-sm rounded-lg;
        }
        .input-modern {
            @apply p-1.5 border border-slate-200 rounded bg-slate-50 focus:bg-white focus:ring-1 focus:ring-brand-500 focus:border-brand-500 text-xxs h-7 transition-all placeholder-slate-400;
        }
        .btn-modern {
            @apply py-0.5 px-3 rounded text-xxs font-bold shadow-sm transition-all h-7 flex items-center justify-center uppercase tracking-wide;
        }
        .section-header-modern {
            @apply text-xs font-bold text-slate-700 border-b border-slate-100 pb-2 mb-2 flex items-center gap-2;
        }
        .label-modern {
            @apply text-[10px] font-semibold text-slate-500 mb-0.5 block;
        }
        .row-item {
            @apply flex items-center p-1 border-b border-slate-50 hover:bg-brand-50 text-xxs transition-colors;
        }
    </style>
</head>
<body class="p-3 flex flex-col relative h-screen box-border text-slate-600">
    
    <!-- Error Log -->
    <div id="error-container" class="hidden absolute top-2 left-1/2 -translate-x-1/2 z-50 bg-danger-50 border border-danger-500 text-danger-600 px-4 py-2 rounded shadow-lg text-xs font-medium">
        <span class="font-bold">Error:</span> <span id="error-message"></span>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-900/30 hidden z-50 flex items-center justify-center backdrop-blur-[2px]">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-64 border border-slate-100 scale-100 transition-transform">
            <h3 class="text-xs font-bold text-slate-800 mb-3 border-b pb-2">Edit Data</h3>
            <form id="edit-form" class="space-y-2">
                <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
                <div><label class="label-modern">Deskripsi</label><input type="text" id="edit-desc" class="input-modern w-full" required></div>
                <div id="edit-field-amount-wrapper"><label class="label-modern">Jumlah (Rp)</label><input type="number" id="edit-amount" class="input-modern w-full" min="0"></div>
                <div id="edit-fields-qty-price" class="hidden grid grid-cols-2 gap-2">
                    <div><label class="label-modern">Qty</label><input type="number" id="edit-qty" class="input-modern w-full" min="1"></div>
                    <div><label class="label-modern">Harga</label><input type="number" id="edit-price" class="input-modern w-full" min="0"></div>
                </div>
                <div class="flex justify-end gap-2 mt-3 pt-2 border-t border-slate-50">
                    <button type="button" id="cancel-edit" class="btn-modern bg-slate-100 text-slate-500 hover:bg-slate-200">Batal</button>
                    <button type="submit" class="btn-modern bg-brand-600 text-white hover:bg-brand-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <header class="flex justify-between items-center px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200 shrink-0 h-10 mb-3">
        <div class="flex items-center gap-2">
            <div class="w-2 h-4 bg-brand-600 rounded-sm"></div>
            <h1 class="text-sm font-extrabold text-slate-800 tracking-tight">Aplikasi Tagihan & Sales SShope</h1>
        </div>
        <div id="auth-status" class="text-[9px] font-bold bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full border border-slate-200">Connecting...</div>
    </header>

    <div id="loading" class="absolute inset-0 bg-white/80 z-40 flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-8 h-8 border-2 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-2"></div>
        <p class="text-brand-600 font-bold text-xs">Sinkronisasi Data...</p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="hidden flex-grow overflow-hidden pb-1">
        <div class="grid grid-cols-12 gap-3 h-full">
            
            <!-- LEFT PANEL: NOTA (45%) -->
            <div class="col-span-5 flex flex-col h-full card-glass overflow-hidden">
                <div class="p-2 pb-0 shrink-0 bg-slate-50/50">
                    <h2 class="section-header-modern text-warning-600 border-warning-200">
                        <span class="bg-warning-100 text-warning-600 p-0.5 rounded">1</span> Rekap Nota Sparepart
                    </h2>
                    <form id="nota-form" class="mb-2 flex gap-1">
                        <input type="text" id="nota-description" placeholder="Deskripsi (TGL 1)" class="input-modern flex-[2]" required>
                        <input type="number" id="nota-amount" placeholder="Rp" class="input-modern flex-[1]" required min="0">
                        <button type="submit" class="btn-modern bg-warning-500 hover:bg-warning-600 text-white w-8 rounded-md shadow-warning-500/30">+</button>
                    </form>
                </div>

                <div class="flex-grow overflow-y-auto px-2">
                    <div id="nota-list-container" class="grid grid-cols-2 gap-x-4 gap-y-0 content-start py-1">
                        <div id="nota-column-1" class="flex flex-col w-full min-w-0"></div>
                        <div id="nota-column-2" class="flex flex-col w-full min-w-0 hidden border-l border-slate-100 pl-4"></div>
                    </div>
                </div>
                
                <div class="shrink-0 p-2 border-t border-slate-100 bg-slate-50">
                    <div class="flex justify-between items-center text-xs font-bold text-slate-700">
                        <span>TOTAL NOTA</span>
                        <span id="total-nota" class="text-warning-600 text-sm">Rp 0</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL (55%) -->
            <div class="col-span-7 flex flex-col h-full gap-3 overflow-hidden">
                
                <!-- TOP RIGHT: EXPENSE & RETUR -->
                <div class="grid grid-cols-2 gap-3 h-[38%] shrink-0">
                    <!-- Tagihan Lain -->
                    <div class="card-glass flex flex-col h-full min-h-0 overflow-hidden">
                        <div class="p-2 pb-0 bg-slate-50/50 shrink-0">
                            <h2 class="section-header-modern text-success-600 border-success-200">
                                <span class="bg-success-100 text-success-600 p-0.5 rounded">2</span> Tagihan Lainnya
                            </h2>
                            <form id="expense-form" class="mb-2 flex gap-1">
                                <input type="text" id="expense-name" placeholder="Nama" class="input-modern flex-[2] min-w-0" required>
                                <input type="number" id="expense-qty" placeholder="Q" class="input-modern w-8 text-center px-0" value="1">
                                <input type="number" id="expense-price" placeholder="Rp" class="input-modern w-14 min-w-0">
                                <button type="submit" class="btn-modern bg-success-500 hover:bg-success-600 text-white w-6">+</button>
                            </form>
                        </div>
                        <div id="expense-list" class="flex-grow overflow-y-auto px-2 py-1"></div>
                        <div class="p-2 border-t border-slate-100 bg-slate-50 shrink-0 flex justify-between text-xxs font-bold text-slate-600">
                            <span>Total Lainnya</span> <span id="total-expense" class="text-success-600">Rp 0</span>
                        </div>
                    </div>

                    <!-- Retur -->
                    <div class="card-glass flex flex-col h-full min-h-0 overflow-hidden">
                        <div class="p-2 pb-0 bg-slate-50/50 shrink-0">
                            <h2 class="section-header-modern text-danger-600 border-danger-200">
                                <span class="bg-danger-100 text-danger-600 p-0.5 rounded">3</span> Retur (Kurang)
                            </h2>
                            <form id="return-form" class="mb-2 flex gap-1">
                                <input type="text" id="return-name" placeholder="Nama" class="input-modern flex-[2] min-w-0" required>
                                <input type="number" id="return-qty" placeholder="Q" class="input-modern w-8 text-center px-0" value="1">
                                <input type="number" id="return-price" placeholder="Rp" class="input-modern w-14 min-w-0">
                                <button type="submit" class="btn-modern bg-danger-500 hover:bg-danger-600 text-white w-6">+</button>
                            </form>
                        </div>
                        <div id="return-list" class="flex-grow overflow-y-auto px-2 py-1"></div>
                        <div class="p-2 border-t border-slate-100 bg-slate-50 shrink-0 flex justify-between text-xxs font-bold text-slate-600">
                            <span>Total Retur</span> <span id="total-return" class="text-danger-600">- Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE: BILLING -->
                <div class="bg-gradient-to-r from-brand-500 to-brand-600 text-white px-4 py-2 rounded-lg shadow-md shrink-0 flex justify-between items-center h-10">
                    <h2 class="text-xs font-bold opacity-90">4. TOTAL BILLING (Harus Dibayar)</h2>
                    <span id="final-billing" class="text-lg font-black tracking-tight">Rp 0</span>
                </div>

                <!-- BOTTOM: PROFIT -->
                <div class="card-glass flex-grow flex flex-col overflow-hidden border-t-4 border-t-brand-500">
                    <div class="p-2 bg-slate-50/50 border-b border-slate-100 shrink-0">
                        <h2 class="text-xs font-bold text-slate-700 flex items-center gap-2">
                            <span class="bg-brand-100 text-brand-600 p-0.5 rounded">5</span> Kalkulasi Profit Bulanan
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-12 h-full min-h-0">
                        <!-- INPUTS -->
                        <div class="col-span-7 p-2 overflow-y-auto border-r border-slate-100">
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2 content-start">
                                <div><label class="label-modern">a. Saldo Bank</label><input type="number" id="saldo-bank" class="input-modern w-full" value="0"></div>
                                <div><label class="label-modern">e. Ongoing Toped TT</label><input type="number" id="ongoing-topedtiktok" class="input-modern w-full" value="0"></div>
                                
                                <div><label class="label-modern">b. Saldo Shopee</label><input type="number" id="saldo-shopee" class="input-modern w-full" value="0"></div>
                                <div><label class="label-modern">f. Saldo Lazada</label><input type="number" id="saldo-lazada" class="input-modern w-full" value="0"></div>
                                
                                <div><label class="label-modern">c. Ongoing Shopee</label><input type="number" id="ongoing-shopee" class="input-modern w-full" value="0"></div>
                                <div><label class="label-modern">g. Ongoing Lazada</label><input type="number" id="ongoing-lazada" class="input-modern w-full" value="0"></div>
                                
                                <div><label class="label-modern">d. Saldo Toped TT</label><input type="number" id="saldo-topedtiktok" class="input-modern w-full" value="0"></div>
                                <!-- HIGHLIGHT SALDO TERPAKAI SEBAGAI POSITIF -->
                                <div><label class="label-modern text-success-600 font-bold">h. Saldo Terpakai (+)</label><input type="number" id="saldo-terpakai" class="input-modern w-full border-success-200 bg-success-50 text-success-700 font-bold" value="0"></div>
                            </div>
                            <button id="calculate-profit-btn" class="btn-modern w-full bg-slate-800 text-white hover:bg-slate-900 mt-3 h-8 shadow-md">HITUNG PROFIT</button>
                        </div>

                        <!-- SUMMARY -->
                        <div class="col-span-5 p-3 flex flex-col justify-center bg-slate-50 gap-2">
                            <div class="space-y-1 text-xxs">
                                <div class="flex justify-between border-b border-slate-200 pb-1">
                                    <span class="text-slate-500">Saldo Kotor</span>
                                    <span id="total-saldo-kotor" class="font-bold text-slate-700">Rp 0</span>
                                </div>
                                <!-- REVISI: Terpakai sekarang (+) -->
                                <div class="flex justify-between border-b border-slate-200 pb-1">
                                    <span class="text-success-600 font-semibold">Terpakai (+)</span>
                                    <span id="saldo-terpakai-display" class="font-bold text-success-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-200 pb-1">
                                    <span class="text-brand-600 font-semibold">Billing (-)</span>
                                    <span id="billing-for-profit" class="font-bold text-brand-600">Rp 0</span>
                                </div>
                            </div>
                            
                            <div class="mt-1 bg-white p-3 rounded-lg border border-brand-100 shadow-sm text-center">
                                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">PROFIT BERSIH</div>
                                <div id="final-profit" class="text-2xl font-black text-slate-800 leading-none">Rp 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        try {
            // CONFIG FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyBtIkNiTVfqi314s7HokDOSkjXnl1P_AoE",
                authDomain: "aplikasi-subarushope.firebaseapp.com",
                projectId: "aplikasi-subarushope",
                storageBucket: "aplikasi-subarushope.firebasestorage.app",
                messagingSenderId: "201701466790",
                appId: "1:201701466790:web:f24db5db1471e173314a67"
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId;

            const els = {
                authStatus: document.getElementById('auth-status'), loading: document.getElementById('loading'), main: document.getElementById('main-content'),
                notaCol1: document.getElementById('nota-column-1'), notaCol2: document.getElementById('nota-column-2'),
                expenseList: document.getElementById('expense-list'), returnList: document.getElementById('return-list'),
                totalNota: document.getElementById('total-nota'), totalExpense: document.getElementById('total-expense'), totalReturn: document.getElementById('total-return'),
                finalBilling: document.getElementById('final-billing'), billingForProfit: document.getElementById('billing-for-profit'),
                finalProfit: document.getElementById('final-profit'), editModal: document.getElementById('edit-modal'), editForm: document.getElementById('edit-form')
            };

            const inputs = {
                bank: document.getElementById('saldo-bank'), shopee: document.getElementById('saldo-shopee'), ongoingShopee: document.getElementById('ongoing-shopee'),
                toped: document.getElementById('saldo-topedtiktok'), ongoingToped: document.getElementById('ongoing-topedtiktok'),
                lazada: document.getElementById('saldo-lazada'), ongoingLazada: document.getElementById('ongoing-lazada'), terpakai: document.getElementById('saldo-terpakai')
            };

            async function initAuth() { try { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); } catch (err) { await signInAnonymously(auth); } }
            initAuth();

            onAuthStateChanged(auth, (user) => {
                if(user) {
                    userId = user.uid;
                    els.authStatus.textContent = `ON | ${userId.slice(0,4)}`;
                    els.loading.classList.add('hidden');
                    els.main.classList.remove('hidden');
                    startListeners();
                }
            });

            let allTransactions = [];
            function getPath(col) { return `artifacts/${appId}/users/${userId}/${col}`; }
            function formatRp(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }

            function startListeners() {
                onSnapshot(query(collection(db, getPath('transactions'))), (snap) => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const notas = data.filter(d => d.type === 'nota').sort((a,b) => (a.date?.seconds || 0) - (b.date?.seconds || 0));
                    const others = data.filter(d => d.type !== 'nota');
                    allTransactions = [...notas, ...others];
                    render(); calc();
                });
                onSnapshot(doc(db, getPath('summary'), 'profit_summary'), (snap) => {
                    if(snap.exists()) { const d = snap.data(); Object.keys(inputs).forEach(key => { if(inputs[key]) inputs[key].value = d[key] || 0; }); }
                    calc();
                });
            }

            window.openEditModal = function(id, type) {
                const item = allTransactions.find(t => t.id === id); if (!item) return;
                document.getElementById('edit-id').value = id; document.getElementById('edit-type').value = type;
                document.getElementById('edit-desc').value = item.description || item.name;
                const isNota = type === 'nota';
                document.getElementById('edit-field-amount-wrapper').classList.toggle('hidden', !isNota);
                document.getElementById('edit-fields-qty-price').classList.toggle('hidden', isNota);
                if(isNota) document.getElementById('edit-amount').value = item.amount;
                else { document.getElementById('edit-qty').value = item.quantity; document.getElementById('edit-price').value = item.price; }
                els.editModal.classList.remove('hidden');
            };
            document.getElementById('cancel-edit').onclick = () => els.editModal.classList.add('hidden');
            
            els.editForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value; const type = document.getElementById('edit-type').value; const desc = document.getElementById('edit-desc').value;
                let newData = type === 'nota' ? { description: desc, amount: parseFloat(document.getElementById('edit-amount').value) } 
                    : { name: desc, quantity: parseFloat(document.getElementById('edit-qty').value), price: parseFloat(document.getElementById('edit-price').value), amount: parseFloat(document.getElementById('edit-qty').value) * parseFloat(document.getElementById('edit-price').value) };
                await updateDoc(doc(db, getPath('transactions'), id), newData); els.editModal.classList.add('hidden');
            };

            function render() {
                els.notaCol1.innerHTML = ''; els.notaCol2.innerHTML = ''; els.expenseList.innerHTML = ''; els.returnList.innerHTML = '';
                const notas = allTransactions.filter(t => t.type === 'nota'); const others = allTransactions.filter(t => t.type !== 'nota');
                notas.slice(0, 30).forEach((t, i) => els.notaCol1.appendChild(createNotaEl(t, i+1)));
                if(notas.length > 30) { els.notaCol2.classList.remove('hidden'); notas.slice(30).forEach((t, i) => els.notaCol2.appendChild(createNotaEl(t, 31+i))); } else els.notaCol2.classList.add('hidden');
                others.forEach(t => (t.type === 'expense' ? els.expenseList : els.returnList).appendChild(createOtherEl(t)));
                document.querySelectorAll('.btn-del').forEach(b => b.onclick = () => deleteDoc(doc(db, getPath('transactions'), b.dataset.id)));
                document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => window.openEditModal(b.dataset.id, b.dataset.type));
            }

            function createNotaEl(t, idx) {
                const div = document.createElement('div'); div.className = 'row-item group';
                div.innerHTML = `<div class="font-bold text-slate-300 w-5 text-center shrink-0 text-[9px]">${idx}.</div><div class="flex-1 min-w-0 flex items-center gap-1 mr-1"><span class="truncate text-slate-600 font-medium flex-1" title="${t.description}">${t.description}</span><span class="text-warning-600 font-bold whitespace-nowrap shrink-0 text-xxs">${formatRp(t.amount)}</span></div><div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity"><button class="p-0.5 text-slate-400 hover:text-brand-600 btn-edit" data-id="${t.id}" data-type="nota">✎</button><button class="p-0.5 text-slate-400 hover:text-danger-600 btn-del" data-id="${t.id}">✕</button></div>`;
                return div;
            }
            function createOtherEl(t) {
                const isExp = t.type === 'expense'; const div = document.createElement('div'); div.className = 'row-item group';
                div.innerHTML = `<span class="truncate font-medium text-slate-600 flex-1" title="${t.name}">${t.name} <span class="text-slate-400 text-[9px]">(${t.quantity}x)</span></span><span class="font-bold ${isExp?'text-success-600':'text-danger-600'} mr-2">${isExp?'':'- '}${formatRp(t.amount)}</span><div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity"><button class="p-0.5 text-slate-400 hover:text-brand-600 btn-edit" data-id="${t.id}" data-type="${t.type}">✎</button><button class="p-0.5 text-slate-400 hover:text-danger-600 btn-del" data-id="${t.id}">✕</button></div>`;
                return div;
            }

            function calc() {
                let sumNota=0, sumExp=0, sumRet=0;
                allTransactions.forEach(t => { if(t.type==='nota') sumNota+=t.amount; else if(t.type==='expense') sumExp+=t.amount; else sumRet+=t.amount; });
                const bill = (sumNota + sumExp) - sumRet;
                els.totalNota.textContent = formatRp(sumNota); els.totalExpense.textContent = formatRp(sumExp); els.totalReturn.textContent = `- ${formatRp(sumRet)}`;
                els.finalBilling.textContent = formatRp(bill); els.billingForProfit.textContent = formatRp(bill);
                
                let vals = {}; Object.keys(inputs).forEach(k => vals[k] = parseFloat(inputs[k].value)||0);
                const kotor = vals.bank + vals.shopee + vals.ongoingShopee + vals.toped + vals.ongoingToped + vals.lazada + vals.ongoingLazada;
                
                // REVISI LOGIC: Terpakai DITAMBAHKAN, bukan dikurangi
                const profit = (kotor + vals.terpakai) - bill;

                document.getElementById('total-saldo-kotor').textContent = formatRp(kotor);
                document.getElementById('saldo-terpakai-display').textContent = formatRp(vals.terpakai); // Just display, calculation happens in profit
                els.finalProfit.textContent = formatRp(profit);
                els.finalProfit.className = `text-2xl font-black leading-none ${profit>=0 ? 'text-brand-700' : 'text-danger-600'}`;

                if(window.saveTimeout) clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => setDoc(doc(db, getPath('summary'), 'profit_summary'), vals, {merge:true}), 1000);
            }

            document.getElementById('nota-form').onsubmit = (e) => { e.preventDefault(); handleAdd('nota', document.getElementById('nota-description').value, document.getElementById('nota-amount').value); e.target.reset(); };
            document.getElementById('expense-form').onsubmit = (e) => { e.preventDefault(); handleAdd('expense', document.getElementById('expense-name').value, 0, document.getElementById('expense-qty').value, document.getElementById('expense-price').value); e.target.reset(); };
            document.getElementById('return-form').onsubmit = (e) => { e.preventDefault(); handleAdd('return', document.getElementById('return-name').value, 0, document.getElementById('return-qty').value, document.getElementById('return-price').value); e.target.reset(); };
            function handleAdd(type, desc, amt=0, qty=1, prc=0) { let data = type === 'nota' ? {description:desc, amount:parseFloat(amt)} : {name:desc, quantity:parseFloat(qty), price:parseFloat(prc), amount:parseFloat(qty)*parseFloat(prc)}; data.type = type; data.date = new Date(); addDoc(collection(db, getPath('transactions')), data); }
            document.getElementById('calculate-profit-btn').onclick = calc; Object.values(inputs).forEach(inp => inp.oninput = calc);

        } catch(e) { document.getElementById('loading').style.display='none'; document.getElementById('error-container').classList.remove('hidden'); document.getElementById('error-message').textContent = e.message; }
    </script>
</body>
</html>
